<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Perceptions -->
    <record id="hr_rule_l10n_mx_payroll_perception_002_e" model="hr.salary.rule">
        <field name="name">Gratificación Anual - Aguinaldo</field>
        <field name="sequence" eval="2000"/>
        <field name="code">PE002</field>
        <field name="l10n_mx_edi_code">002</field>
        <field name="category_id" ref="hr_salary_rule_category_perception_mx_exempt"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
bonus_total = (contract.wage/30) * (contract.l10n_mx_edi_christmas_bonus or 15)
seniority = contract.get_seniority(date_to=payslip.date_to)

if 1 > seniority['years']:
    bonus_total = (bonus_total / 365) * seniority['days']

# Minimum wage set with values of SAT http://www.sat.gob.mx/informacion_fiscal/tablas_indicadores/Documents/salarios_minimos_historico.xls

uma = contract.company_id.l10n_mx_edi_uma
amount_exempt = uma * 30.4

diff =  bonus_total - amount_exempt

result = bonus_total
if diff >= 0:
    result =  amount_exempt</field>
        <field name="note">Sólo 30 días de SM queda exento, el excedente es gravado</field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_perception_002_g" model="hr.salary.rule">
        <field name="name">Gratificación Anual - Aguinaldo</field>
        <field name="sequence" eval="2000"/>
        <field name="code">PG002</field>
        <field name="l10n_mx_edi_code">002</field>
        <field name="category_id" ref="hr_salary_rule_category_perception_mx_taxed"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
bonus_total = (contract.wage/30) * (contract.l10n_mx_edi_christmas_bonus or 15)
seniority = contract.get_seniority(date_to=payslip.date_to)

if 1 > seniority['years']:
    bonus_total = (bonus_total /365) * seniority['days']

# Minimum wage set with values of SAT http://www.sat.gob.mx/informacion_fiscal/tablas_indicadores/Documents/salarios_minimos_historico.xls

uma = contract.company_id.l10n_mx_edi_uma
amount_exempt = uma * 30.4

diff =  bonus_total - amount_exempt
result = 0
if diff > 0:
    result =  diff</field>
        <field name="note">Sólo 30 días de SM queda exento, el excedente es gravado</field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_perception_021_e_christmas" model="hr.salary.rule">
        <field name="name">Prima vacacional</field>
        <field name="sequence" eval="21000"/>
        <field name="code">PE021</field>
        <field name="l10n_mx_edi_code">021</field>
        <field name="category_id" ref="hr_salary_rule_category_perception_mx_exempt"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
vacation_bonus_type = (payslip.company_id or contract.company_id).l10n_mx_edi_vacation_bonus
result = 0
holidays = contract.l10n_mx_edi_holidays if vacation_bonus_type == 'on_christmas_bonus' else 0
if holidays:
    daily_wage = contract.wage / 30
    uma = contract.company_id.l10n_mx_edi_uma
    result = daily_wage * holidays * contract.l10n_mx_edi_vacation_bonus / 100
    result = uma * 15 if result >= (uma * 15) else result
        </field>
        <field name="note">Sólo 15 UMA son exentos, el excedente es gravado</field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_perception_021_g_christmas" model="hr.salary.rule">
        <field name="name">Prima vacacional</field>
        <field name="sequence" eval="21000"/>
        <field name="code">PG021</field>
        <field name="l10n_mx_edi_code">021</field>
        <field name="category_id" ref="hr_salary_rule_category_perception_mx_taxed"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
vacation_bonus_type = (payslip.company_id or contract.company_id).l10n_mx_edi_vacation_bonus
result = 0
holidays = contract.l10n_mx_edi_holidays if vacation_bonus_type == 'on_christmas_bonus' else 0
if holidays:
    daily_wage = contract.wage / 30
    uma = contract.company_id.l10n_mx_edi_uma
    result = daily_wage * holidays * contract.l10n_mx_edi_vacation_bonus / 100
    result = result - uma * 15 if result >= uma * 15 else 0
        </field>
        <field name="note">Sólo 15 UMA son exentos, el excedente es gravado</field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_deduction_isr_02" model="hr.salary.rule">
        <field name="name">AUX ISR</field>
        <field name="sequence" eval="53500"/>
        <field name="code">AUX_ISR</field>
        <field name="category_id" ref="hr_salary_rule_category_aux_mx"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
income_period = categories.PERGRA
# Table ISR (limite_inferior, limite_superior, cuota_fija, tasa)
table = {'05': [(0.01, 644.58, 0.00, 0.0192), (644.59, 5470.92, 12.38, 0.0640),
         (5470.93, 9614.66, 321.26, 0.1088), (9614.67, 11176.62, 772.10, 0.1600),
         (11176.63, 13381.47, 1022.01, 0.1792), (13381.48, 26988.5, 1417.12, 0.2136),
         (26988.51, 42537.58, 4323.58, 0.2352), (42537.59, 81211.25, 7980.73, 0.3000),
         (81211.26, 108281.67, 19582.83, 0.3200), (108281.68, 324845.01, 28245.36, 0.3400),
         (324845.01, 999999999, 101876.9, 0.3500)],
         '04': [(0.01, 318.0, 0.00, 0.0192), (318.01, 2699.4, 6.15, 0.0640),
         (2699.41, 4744.05, 158.55,  0.1088), (4744.06, 5514.75, 381.00,  0.1600),
         (5514.76, 6602.7, 504.3,  0.1792), (6602.71, 13316.7, 699.3, 0.2136),
         (13316.71, 20988.9, 2133.3, 0.2352), (20988.91, 40071.3, 3937.8, 0.3000),
         (40071.31, 53428.5, 9662.55, 0.3200), (53428.51, 160285.35, 13936.80, 0.3400),
         (160285.36, 999999999, 50268.15, 0.3500)],
         '02': [(0.01, 148.4, 0.00, 0.0192), (148.41, 1259.72, 2.87, 0.0640),
         (1259.73, 2213.89, 73.99, 0.1088), (2213.90, 2573.55, 177.80, 0.1600),
         (2573.56, 3081.26, 235.34, 0.1792), (3081.27, 6214.46, 326.34, 0.2136),
         (6214.47, 9794.82, 995.54, 0.2352), (9794.83, 18699.94, 1837.64, 0.3000),
         (18699.95, 24933.30, 4509.19, 0.3200), (24933.31, 74799.83, 6503.84, 0.3400),
         (74799.84, 99999999, 23458.47, 0.3500)],
         '01': [(0.01, 21.20, 0.00, 0.0192), (21.21, 179.96, 0.41, 0.0640),
         (179.97, 316.27, 10.57, 0.1088), (316.28, 367.65, 25.40, 0.1600),
         (367.66, 440.18, 33.62, 0.1792), (440.19, 887.78, 46.62, 0.2136),
         (887.79, 1399.26, 142.22, 0.2352), (1399.27, 2671.42, 262.52, 0.3000),
         (2671.43, 3561.90, 644.17, 0.3200), (3561.91, 10685.69, 929.12, 0.3400),
         (10685.70, 99999999, 3351.21, 0.3500)],
         '10': [(0.01, 212, 0.00, 0.0192), (212.01, 1799.6, 4.10, 0.0640),
         (1799.61, 3162.70, 105.70, 0.1088), (3162.71, 3676.50, 254, 0.1600),
         (3676.51, 4401.80, 466.20, 0.1792), (4401.81, 8877.80, 466.20, 0.2136),
         (8877.81, 13992.60, 1422.20, 0.2352), (13992.61, 26714.20, 2625.20, 0.3000),
         (26714.21, 35619, 6441.70, 0.3200), (35619.01, 106856.90, 9291.20, 0.3400),
         (106856.91, 99999999, 33512.10, 0.3500)]}
result = 0
table_isr = table.get(contract.l10n_mx_edi_schedule_pay, [])
if table_isr:
    for value in table_isr:
        if income_period >=value[0] and value[1] >= income_period:
            extra = income_period - value[0]
            result = ((extra * value[3]) + value[2]) * -1
            break
if not payslip.company_id.l10n_mx_edi_isr_annual_adjustment and payslip.dict.l10n_mx_edi_is_last_payslip():
    category = employee.env.ref('l10n_mx_edi_payslip.hr_salary_rule_category_perception_mx_taxed')
    payslips = employee.slip_ids.filtered(lambda sl: sl.state == 'done' and sl.id != payslip.id and sl.date_from.month == payslip.date_from.month and sl.date_from.year == payslip.date_from.year)
    lines = payslips.mapped('line_ids')
    income_monthly = income_period + sum(lines.filtered(lambda li: li.category_id.id == category.id).mapped('total'))
    for value in table['05']:
        if income_monthly >=value[0] and value[1] >= income_monthly:
            extra = income_monthly - value[0]
            result = ((extra * value[3]) + value[2]) * -1
            break
    rule = employee.env.ref('l10n_mx_edi_payslip.hr_rule_l10n_mx_payroll_deduction_isr')
    result = result - sum(lines.filtered(lambda li: li.salary_rule_id == rule).mapped('total'))
        </field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_other_payment_aux_02" model="hr.salary.rule">
        <field name="name">Auxiliar Subsidio para el empleo</field>
        <field name="code">AUX_OP002</field>
        <field name="sequence">53501</field>
        <field name="category_id" ref="hr_salary_rule_category_aux_mx"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
# Based on http://www.sat.gob.mx/informacion_fiscal/devoluciones_compensaciones/Paginas/subsidio_al_empleo.aspx
# TODO - Complete tables
income_period = categories.PERGRA
table = {
    '05': [
        (0.01, 1768.96, 407.02),
        (1768.97, 2653.38, 406.83),
        (2653.39, 3472.84, 406.62),
        (3472.85, 3537.87, 392.77),
        (3537.88, 4446.15, 382.46),
        (4446.16, 4717.18, 354.23),
        (4717.19, 5335.42, 324.87),
        (5335.43, 6224.67, 294.63),
        (6224.68, 7113.90, 253.54),
        (7113.91, 7382.33, 217.61),
        (7382.34, 99999999.00, 0)],
    '04': [
        (0.01, 872.85, 200.85),
        (872.86, 1309.20, 200.70),
        (1309.21, 1713.60, 200.70),
        (1713.61, 1745.70, 193.80),
        (1745.71, 2193.75, 188.70),
        (2193.76, 2327.55, 174.75),
        (2327.56, 2632.65, 160.35),
        (2632.66, 3071.40, 145.35),
        (3071.41, 3510.15, 125.10),
        (3510.16, 3642.60, 107.40),
        (3642.61, 99999999.00, 0)],
}
result = 0.00
table = table.get(contract.l10n_mx_edi_schedule_pay, [])
if table:
    for value in table:
        if income_period >=value[0] and value[1] >= income_period:
            result = value[2]
            break</field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_deduction_aguinaldo_002" model="hr.salary.rule">
        <field name="name">ISR - Aguinaldo</field>
        <field name="sequence" eval="55100"/>
        <field name="code">002</field>
        <field name="l10n_mx_edi_code">002</field>
        <field name="category_id" ref="hr_salary_rule_category_deduction_mx"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
table = [(0.01, 644.58, 0.00, 0.0192), (644.59, 5470.92, 12.38, 0.0640),
         (5470.93, 9614.66, 321.26, 0.1088), (9614.67, 11176.62, 772.10, 0.1600),
         (11176.63, 13381.47, 1022.01, 0.1792), (13381.48, 26988.5, 1417.12, 0.2136),
         (26988.51, 42537.58, 4323.58, 0.2352), (42537.59, 81211.25, 7980.73, 0.3000),
         (81211.26, 108281.67, 19582.83, 0.3200), (108281.68, 324845.01, 28245.36, 0.3400),
         (324845.01, 999999999, 101876.9, 0.3500)]
income_period = categories.PERGRA
income_exe = categories.PEREXE
wage = contract.wage

year = (payslip.l10n_mx_edi_payment_date or payslip.date_from).year
days_year = 365
if year % 4 == 0 and year % 100 != 0 or year % 400 == 0:
    days_year = 366

art_174_lisr = income_period /days_year * 30.4
base_gravable = art_174_lisr + wage

result1 = result2 = 0

for value in table:
   if base_gravable >=value[0] and value[1] >= base_gravable:
       result1 = (((base_gravable - value[0]) * value[3]) + value[2]) * -1

for value in table:
   if wage >=value[0] and value[1] >= wage:
       result2 = (((wage - value[0]) * value[3]) + value[2]) * -1

isr = result2 - result1
efective_rate = isr / (art_174_lisr or 1)
result = (income_period * efective_rate)
        </field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_deduction_071_02" model="hr.salary.rule">
        <field name="name">Ajuste en Subsidio para el empleo - efectivamente entregado al trabajador</field>
        <field name="sequence" eval="81700"/>
        <field name="code">071</field>
        <field name="l10n_mx_edi_code">071</field>
        <field name="category_id" ref="hr_salary_rule_category_deduction_mx"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
# Based on http://www.sat.gob.mx/informacion_fiscal/devoluciones_compensaciones/Paginas/subsidio_al_empleo.aspx
income_period = categories.PERGRA
table = [(0.01, 1768.96, 407.02), (1768.97, 2653.38, 406.83),
         (2653.39, 3472.84, 406.62), (3472.85, 3537.87, 392.77),
         (3537.88, 4446.15, 382.46), (4446.16, 4717.18, 354.23),
         (4717.19, 5335.42, 324.87), (5335.43, 6224.67, 294.63),
         (6224.68, 7113.90, 253.54), (7113.91, 7382.33, 217.61),
         (7382.34, 99999999.00, 0)]
days_schedule = {'01': 1, '02': 7, '03': 14, '04': 15, '05': 30}
result = -0.01
days_work = days_schedule.get(contract.l10n_mx_edi_schedule_pay, 0)
if days_work:
    income_period = (income_period / days_work) * 30
    for value in table:
        if income_period >=value[0] and value[1] >= income_period:
            result = value[2]
            break
    result = 0.01 if not (result * days_work) / 30 else 0 </field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_other_payment_002_02" model="hr.salary.rule">
        <field name="name">Subsidio para el empleo - efectivamente entregado al trabajador</field>
        <field name="code">OP002</field>
        <field name="l10n_mx_edi_code">002</field>
        <field name="sequence">87000</field>
        <field name="category_id" ref="hr_salary_rule_category_other_mx"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = AUX_OP002
result = result + AUX_ISR if result &gt; abs(AUX_ISR) else 0.01</field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_deduction_007_a02" model="hr.salary.rule">
        <field name="name">Pensión alimenticia</field>
        <field name="sequence" eval="600006"/>
        <field name="code">A02007</field>
        <field name="l10n_mx_edi_code">007</field>
        <field name="category_id" ref="hr_salary_rule_category_deduction_mx"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = 0
alimony = employee.l10n_mx_edi_alimony_ids.filtered(lambda a: a.date_from &lt;= payslip.date_from and (not a.date_to or a.date_to and a.date_to &gt;= payslip.date_to))
if alimony and len(alimony) &gt; 5:
    alimony = alimony[5]
    if alimony.discount_type == 'percentage_christmas_holidays':
        result += (PE002 + PG002 + PE3023 + PG3023 + PE021 + PG021 + PE2023 + PG2023) * alimony.discount_amount / 100
    elif alimony.discount_type == 'percentage_christmas':
        result += (PE002 + PG002 + PE3023 + PG3023) * alimony.discount_amount / 100
    elif alimony.discount_type == 'amount_fixed_christmas' and (PE002 + PG002):
        result += alimony.discount_amount
        </field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_deduction_007_b02" model="hr.salary.rule">
        <field name="name">Pensión alimenticia</field>
        <field name="sequence" eval="600006"/>
        <field name="code">B02007</field>
        <field name="l10n_mx_edi_code">007</field>
        <field name="category_id" ref="hr_salary_rule_category_deduction_mx"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = 0
alimony = employee.l10n_mx_edi_alimony_ids.filtered(lambda a: a.date_from &lt;= payslip.date_from and (not a.date_to or a.date_to and a.date_to &gt;= payslip.date_to))
if alimony and len(alimony) &gt; 5:
    alimony = alimony[5]
    if alimony.discount_type == 'percentage_christmas_holidays':
        result += (PE002 + PG002 + PE3023 + PG3023 + PE021 + PG021 + PE2023 + PG2023) * alimony.discount_amount / 100
    elif alimony.discount_type == 'percentage_christmas':
        result += (PE002 + PG002 + PE3023 + PG3023) * alimony.discount_amount / 100
    elif alimony.discount_type == 'amount_fixed_christmas' and (PE002 + PG002):
        result += alimony.discount_amount
        </field>
    </record>
    <record id="hr_rule_l10n_mx_payroll_deduction_007_c02" model="hr.salary.rule">
        <field name="name">Pensión alimenticia</field>
        <field name="sequence" eval="600006"/>
        <field name="code">C02007</field>
        <field name="l10n_mx_edi_code">007</field>
        <field name="category_id" ref="hr_salary_rule_category_deduction_mx"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">
result = 0
alimony = employee.l10n_mx_edi_alimony_ids.filtered(lambda a: a.date_from &lt;= payslip.date_from and (not a.date_to or a.date_to and a.date_to &gt;= payslip.date_to))
if alimony and len(alimony) &gt; 5:
    alimony = alimony[5]
    if alimony.discount_type == 'percentage_christmas_holidays':
        result += (PE002 + PG002 + PE3023 + PG3023 + PE021 + PG021 + PE2023 + PG2023) * alimony.discount_amount / 100
    elif alimony.discount_type == 'percentage_christmas':
        result += (PE002 + PG002 + PE3023 + PG3023) * alimony.discount_amount / 100
    elif alimony.discount_type == 'amount_fixed_christmas' and (PE002 + PG002):
        result += alimony.discount_amount
        </field>
    </record>
    <record id="hr_rule_net_salary_02" model="hr.salary.rule">
        <field name="name">Net Salary</field>
        <field name="sequence" eval="1000000"/>
        <field name="code">NetSalary</field>
        <field name="category_id" ref="hr_salary_rule_category_netsa_mx"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="amount_python_compute">result = categories.PERGRA - categories.DEDUC + categories.PEREXE + categories.OTHER</field>
    </record>
    <record id="hr_rule_l10n_mx_isn_chrismas" model="hr.salary.rule">
        <field name="name">ISN - Aguinaldo</field>
        <field name="sequence" eval="1000005"/>
        <field name="code">ISN</field>
        <field name="category_id" ref="hr_payroll.COMP"/>
        <field name="struct_id" ref="payroll_structure_data_02"/>
        <field name="condition_select">none</field>
        <field name="amount_select">code</field>
        <field name="note">Gravado multiplicado por el porcentaje de ISN del estado de la dirección de trabajo y agregado a Company Contribution</field>
        <field name="amount_python_compute">
result= categories.PERGRA * employee.address_id.state_id.l10n_mx_payslip_isn
        </field>
    </record>
</odoo>
